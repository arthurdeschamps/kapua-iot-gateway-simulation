<h1 id="technical-overview">Technical overview</h1>

<h2 id="introduction">Introduction</h2>

<p>There are basically three main blocks in this simulation. <strong>Simulator</strong> and <strong>data-transmitter</strong> are both entirely written in Java. They are both maven modules. The third one is a frontend application, <strong>webapp-angular</strong>, that is coded in Dart using the AngularDart framework.</p>

<ul>
<li><p><strong>Simulator</strong>: Handles the simulation part, generates fake data and also provides them to Kapua via the <em>MQTT</em> protocol and the angular web application via the <em>WebSocket</em> protocol. It also accepts some “set” requests from the frontend concerning its parametrisation.</p></li>
<li><p><strong>Data-transmitter</strong>: Subscribes via <em>MQTT</em> to every topics that creates <strong>simulator</strong> using the “#” wildcard and transmits the received data to angular via <em>WebSocket</em>.</p></li>
<li><p><strong>Webapp-angular</strong>: Communicates with both <strong>simulator</strong> and <strong>data-transmitter</strong> through <em>WebSocket</em> in order to get telemetry and application data. Use this data in multiple forms (Map, Chart, etc). Also provides a settings section to allow the user to customise the simulation.</p></li>
</ul>

<p>Here is a simple scheme describing the general flow of the simulation: <br>
<img src="https://lh3.googleusercontent.com/-ojbfSdIwauI/WYIYOTDsDDI/AAAAAAAACY4/_LVWBRHiJ3cfJLpv-i0QEE8WD3gy0GqewCLcBGAs/s0/untitled+%25281%2529.png" alt="enter image description here" title="scheme.png"></p>



<h2 id="simulator">Simulator</h2>

<p>The main simulator uses 3 sub-simulators: <strong>company</strong>, <strong>economy</strong> and <strong>telemetry</strong> simulators. One execution of any of these 3 simulators corresponds to 1 hour elapsed in <em>virtual time</em>. <br>
This <em>virtual time</em> is used to speed up the simulation, since we don’t want to wait a week in front of our computer to see our first order, for example. The default simulation uses a virtual time 3600 times faster than real time, but it is obviously customisable.</p>

<p>The <strong>parametrizer</strong> is used to customise the simulation. For example, it can be used to stretch out the interval of time between each “publish” on Kapua. </p>

<p>The <strong>company simulator</strong> simulates everything related to the company and also acts as a “customer” simulator. By using randomness, it triggers events such as gaining or losing a customer, creating a new type of product, building products based on a product type, receiving orders from customers, planning deliveries, etc. These events are heavily correlated to the economy simulator, since their likelihood depends in majority on its attributes: growth, demand, concurrency, etc.</p>

<p>The <strong>economy simulator</strong> is a simple and purely random-based simulator which fluctuates the parameters defined in the <strong>Economy</strong> class.</p>

<p>Last but not least, the <strong>telemetry simulator</strong> reacts to some events triggered the company and generates data in consequence. For instance, if a delivery goes from state “warehouse” to “shipping”, this simulator will start virtually moving the delivery towards its destination and update the underlying data (delivery position, transportation usage, etc)</p>

<p>Aside from the simulation, a service called <strong>DataSenderRunner</strong> is responsible for periodically sending telemetry data (generated by the telemetry simulator) to Kapua.</p>

<p>Finally, the simulator offers a WebSocket service that can interact with the frontend, either by answering to non-telemetry data requests or by modifying the simulation itself via parametrizer-related requests.</p>

<h2 id="data-transmitter">Data transmitter</h2>

<p>This service takes care of subscribing to every topic. During its initialisation, it sends a message like “subscribe #” to the Kapua broker, which means the broker will send it copies of every data received from the simulator.</p>

<p>At the same time, the data transmitter opens a websocket server. Every time a client connects to this socket, it is added to the <strong>subscribers list</strong>.</p>

<p>Any package received from the broker is then broadcasted to the <strong>subscribers list</strong>.</p>

<h2 id="webapp-angular">Webapp-angular</h2>

<p>AngularDart makes it possible to build a rich user interface without ever having to refresh the page. Data can go both ways, from the UI to angular and from angular to the UI.  <br>
The simulation uses this system to dynamically update the graphical interface every time data is received through the WebSocket. It also makes it possible to update the <strong>parametrizer</strong> on user’s inputs on the fly.</p>

<p>There are three views in the web application: <strong>Map</strong>, <strong>Company data</strong> and <strong>Settings</strong>. </p>

<p><strong>Map</strong> displays deliveries in real time on a map, using Leaflet library. Clicking on a delivery marker will make a pop up appearing, showing a few information about the selected delivery.  <br>
Deliveries not in transit anymore (cancelled, delivered, etc) will disappear from the map.</p>

<p><strong>Company data</strong> shows the quantity evolution of each <em>storage</em> (e.g. customers, orders, deliveries) on two components: a chart and a table. The chart is generated with Chart.js.</p>

<p><strong>Settings</strong> lets the user customise the simulation. He can change for example the simulation’s time flow, name of the company, etc.</p>

<h2 id="technologies">Technologies</h2>

<ul>
<li><strong>Languages</strong> <br>
<ul><li>Java: simulation, MQTT clients + WebSocket servers</li>
<li>Dart: AngularDart frontend app</li></ul></li>
<li><strong>Tests</strong> <br>
<ul><li>JUnit with Java</li></ul></li>
<li><strong>Build automation tool</strong> <br>
<ul><li>Apache Maven</li></ul></li>
<li><strong>Continous integration tool</strong> <br>
<ul><li>Travis</li></ul></li>
<li><strong>Frontend package manager</strong> <br>
<ul><li>Bower</li></ul></li>
</ul>